service: wireguard-manager
frameworkVersion: '3'
provider:
  name: aws
  stage: ${opt:stage, 'dev'}
  region: us-west-2
  disableRollback: true
params:
  default:
    VpcId: ${param:vpc-id, null} # The VPC for the App Runner VPC endpoint
    IngressSubnetIds: ${param:ingress-subnet-ids, null} # The VPC subnets for the App Runner VPC endpoint
    WgManagerVersion: ${param:wg-manager-version, 'latest'} # Wireguard Manager version (Docker tag)
    # ---- App Runner container runtime ----
    UvicornPort: ${param:uvicorn-port, '5000'}
    UvicornHost: ${param:uvicorn-host, '0.0.0.0'}
resources:
  Resources:
    # ---------- DynamoDB tables ----------
    WireguardManagerVpnServersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        AttributeDefinitions:
          - AttributeName: name
            AttributeType: S
        KeySchema:
          - AttributeName: name
            KeyType: HASH
        ProvisionedThroughput: {ReadCapacityUnits: 1, WriteCapacityUnits: 1}
        TableName: wireguard-manager-vpn-servers-${self:provider.stage}
    WireguardManagerPeersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        AttributeDefinitions:
          - AttributeName: peer_id
            AttributeType: S
        KeySchema:
          - AttributeName: peer_id
            KeyType: HASH
        ProvisionedThroughput: {ReadCapacityUnits: 1, WriteCapacityUnits: 1}
        TableName: wireguard-manager-peers-${self:provider.stage}
    WireguardManagerPeersHistoryTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: wireguard-manager-peers-history-${self:provider.stage}
        AttributeDefinitions:
          - {AttributeName: peer_history_id, AttributeType: S}
          - {AttributeName: timestamp, AttributeType: N}
          - {AttributeName: vpn_name_ip_addr, AttributeType: S}
          - {AttributeName: vpn_name_tag, AttributeType: S}
        KeySchema:
          - {AttributeName: peer_history_id, KeyType: HASH}
          - {AttributeName: timestamp, KeyType: RANGE}
        GlobalSecondaryIndexes:
          - IndexName: GSI-byIp
            KeySchema:
              - {AttributeName: vpn_name_ip_addr, KeyType: HASH}
              - {AttributeName: timestamp, KeyType: RANGE}
            Projection: {ProjectionType: ALL}
            ProvisionedThroughput: {ReadCapacityUnits: 1, WriteCapacityUnits: 1}
          - IndexName: GSI-byTag
            KeySchema:
              - {AttributeName: vpn_name_tag, KeyType: HASH}
              - {AttributeName: timestamp, KeyType: RANGE}
            Projection: {ProjectionType: ALL}
            ProvisionedThroughput: {ReadCapacityUnits: 1, WriteCapacityUnits: 1}
        ProvisionedThroughput: {ReadCapacityUnits: 1, WriteCapacityUnits: 1}
    # ---------- App Runner runtime role (DynamoDB + SSM) ----------
    WireguardManagerAppRunnerInstanceRole:
      Type: AWS::IAM::Role
      Properties:
        RoleName: WireguardManagerAppRunnerInstanceRole-${self:provider.stage}
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal: {Service: tasks.apprunner.amazonaws.com}
              Action: sts:AssumeRole
        Policies:
          - PolicyName: WireguardManagerAppRunnerDdb-${self:provider.stage}
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Effect: Allow
                  Action:
                    - dynamodb:DescribeTable
                    - dynamodb:PutItem
                    - dynamodb:GetItem
                    - dynamodb:UpdateItem
                    - dynamodb:DeleteItem
                    - dynamodb:Query
                    - dynamodb:Scan
                  Resource:
                    - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/wireguard-manager-vpn-servers-${self:provider.stage}*
                    - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/wireguard-manager-peers-${self:provider.stage}*
                    - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/wireguard-manager-peers-history-${self:provider.stage}*
          - PolicyName: WireguardManagerAppRunnerSsm-${self:provider.stage}
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Effect: Allow
                  Action:
                    - ssm:SendCommand
                    - ssm:GetCommandInvocation
                    - ssm:StartSession
                    - ssm:TerminateSession
                    - ssm:DescribeSessions
                    - ssm:DescribeInstanceInformation
                  Resource: "*"
    # ---------- Private App runner ingress (Interface + VpcIngressConnection) ----------
    AppRunnerVpcSecurityGroup:
      Type: AWS::EC2::SecurityGroup
      Properties:
        GroupDescription: Allow TLS to App Runner VPC endpoint
        VpcId: ${param:VpcId}
        SecurityGroupIngress:
          - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            CidrIp: 0.0.0.0/0
        SecurityGroupEgress:
          - IpProtocol: -1
            CidrIp: 0.0.0.0/0
    AppRunnerInterfaceEndpoint:
      Type: AWS::EC2::VPCEndpoint
      Properties:
        VpcId: ${param:VpcId}
        ServiceName: !Sub com.amazonaws.${AWS::Region}.apprunner.requests
        VpcEndpointType: Interface
        SubnetIds:
          Fn::Split: [",", "${param:IngressSubnetIds}"]
        PrivateDnsEnabled: false
        SecurityGroupIds: [!Ref AppRunnerVpcSecurityGroup]
    WireguardManagerAppRunnerService:
      Type: AWS::AppRunner::Service
      DependsOn:
        - WireguardManagerAppRunnerInstanceRole
        - WireguardManagerPeersTable
        - WireguardManagerPeersHistoryTable
        - WireguardManagerVpnServersTable
      Properties:
        ServiceName: wireguard-manager-${self:provider.stage}
        SourceConfiguration:
          AuthenticationConfiguration: {}
          AutoDeploymentsEnabled: false
          ImageRepository:
            ImageIdentifier: public.ecr.aws/g0d6f2g5/wireguard-manager:${param:WgManagerVersion}
            ImageRepositoryType: ECR_PUBLIC
            ImageConfiguration:
              Port: "${param:UvicornPort}"
              RuntimeEnvironmentVariables:
                - {Name: ENVIRONMENT, Value: "${self:provider.stage}"}
                - {Name: AWS_REGION, Value: "${self:provider.region}"}
                - {Name: UVICORN_HOST, Value: "${param:UvicornHost}"}
                - {Name: UVICORN_PORT, Value: "${param:UvicornPort}"}
        InstanceConfiguration:
          Cpu: "1 vCPU"
          Memory: "2 GB"
          InstanceRoleArn: !GetAtt WireguardManagerAppRunnerInstanceRole.Arn
        HealthCheckConfiguration:
          Protocol: HTTP
          Path: /
          Interval: 10
          Timeout: 5
          HealthyThreshold: 1
          UnhealthyThreshold: 3
        NetworkConfiguration:
          IngressConfiguration:
            IsPubliclyAccessible: false # PRIVATE ONLY (ingress)
    WireguardManagerVpcIngressConnection:
      Type: AWS::AppRunner::VpcIngressConnection
      DependsOn:
        - WireguardManagerAppRunnerService
        - AppRunnerInterfaceEndpoint
      DeletionPolicy: Retain # Optional: helps debugging, remove for production
      Properties:
        VpcIngressConnectionName: wireguard-manager-${self:provider.stage}-ingress
        ServiceArn: !GetAtt WireguardManagerAppRunnerService.ServiceArn
        IngressVpcConfiguration:
          VpcId: ${param:VpcId}
          VpcEndpointId: !Ref AppRunnerInterfaceEndpoint
